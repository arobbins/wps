function edd_stripe_response_handler(e,d){if(d.error){jQuery("#edd_purchase_form #edd-purchase-button, #edd_profile_editor_form #edd_profile_editor_submit, #edd-recurring-form #edd-recurring-update-submit").attr("disabled",!1);var a='<div class="edd_errors"><p class="edd_error">'+d.error.message+"</p></div>";jQuery("#edd-stripe-payment-errors").html(a),jQuery(".edd-loading-ajax").hide(),edd_global_vars.complete_purchase?jQuery("#edd-purchase-button").val(edd_global_vars.complete_purchase):jQuery("#edd-purchase-button").val("Purchase")}else{var t=jQuery("#edd_purchase_form, #edd_profile_editor_form, #edd-recurring-form");if(!1!==d){var r=d.id;t.append("<input type='hidden' name='edd_stripe_token' value='"+r+"' />")}t.get(0).submit()}}function edd_stripe_add_card_handler(e,d){if(d.error){var a='<div class="edd_errors"><p class="edd_error">'+d.error.message+"</p></div>";jQuery(".edd-stripe-add-card-actions").append(a)}else if(!1!==d){var t=d.id;jQuery(".edd-stripe-add-new-card").append("<input type='hidden' id='edd-stripe-new-token' name='edd_stripe_token' value='"+t+"' />")}}function edd_stripe_process_card(e,d){return Stripe.createToken(e,d),!1}jQuery(document).ready(function(e){({init:function(){var d=e("body");this.existing_cards(d),this.toggle_address_update(d)},existing_cards:function(d){d.on("click",".edd-stripe-existing-card",function(){if(edd_scripts.is_checkout){e(".edd-stripe-card-radio-item").removeClass("selected"),e(this).parent().addClass("selected");var d=e(this).val(),a=e(".edd-stripe-new-card"),t=e("#edd_cc_address p input, #edd_cc_address p select").not("#edd-stripe-update-billing-address"),r=e(".edd-stripe-update-billing-address-wrapper");if("new"===d)a.slideDown(),t.prop("readonly",!1),r.hide();else{a.slideUp(),r.show();var s=e("#"+d+"-billing-details");e("#card_address").val(s.data("address_line1")),e("#card_address_2").val(s.data("address_line2")),e("#card_city").val(s.data("address_city")),e("#card_zip").val(s.data("address_zip")),e("#billing_country").val(s.data("address_country")).trigger("change"),setTimeout(function(){e("#card_state").val(s.data("address_state")).trigger("change").prop("readonly",!0)},1500),t.prop("readonly",!0)}}})},toggle_address_update:function(d){d.on("click","#edd-stripe-update-billing-address",function(){var d=e(this).is(":checked"),a=e("#edd_cc_address p input, #edd_cc_address p select").not(e(this));d?a.prop("readonly",!1):a.prop("readonly",!0)})}}).init(),{init:function(){this.add_new(),this.cancel_add_new(),this.update(),this.cancel_update(),this.submit_update(),this.change_country(),this.set_default(),this.delete()},add_new:function(){e(".edd-stripe-add-new").click(function(d){if(e(".edd-stripe-add-new-card").is(":visible")){var a=e(this),t=a.width();a.removeClass(".edd-stripe-add-new"),a.find(".button-text").hide(),a.find(".edd-loading").show(),a.css("width",t);var r=e(".edd-stripe-add-new-card");"US"==r.find(".billing-country").val()?state=r.find("#card_state_us").val():"CA"==r.find(".billing-country").val()?state=r.find("#card_state_ca").val():state=r.find("#card_state_other").val(),void 0!==r.find("#card_state_us").val()?"US"==r.find(".billing-country").val()?state=r.find("#card_state_us").val():"CA"==r.find(".billing-country").val()?state=r.find("#card_state_ca").val():state=r.find("#card_state_other").val():state=r.find(".card_state").val();var s={};s.number=r.find(".card-number").val(),s.name=r.find(".card-name").val(),s.cvc=r.find(".card-cvc").val(),s.exp_month=r.find(".card-expiry-month").val(),s.exp_year=r.find(".card-expiry-year").val(),s.address_line1=r.find(".card-address").val(),s.address_line2=r.find(".card-address-2").val(),s.address_city=r.find(".card-city").val(),s.address_state=state,s.address_zip=r.find(".card-zip").val(),s.address_country=r.find(".billing_country").val(),edd_stripe_process_card(s,edd_stripe_add_card_handler),setTimeout(function(){var d=e(".edd-stripe-add-new"),a={edd_action:"add_stripe_card",token:e("body").find("#edd-stripe-new-token").val(),user_id:e("#stripe-update-card-user_id").val(),nonce:e('input[name="edd-stripe-add-card-nonce"]').val()};e.ajax({type:"POST",data:a,dataType:"json",url:edd_scripts.ajaxurl,xhrFields:{withCredentials:!0},success:function(e){if(!0!==e.success)return d.addClass(".edd-stripe-add-new"),d.find(".button-text").show(),d.find(".edd-loading").hide(),d.css("width","auto"),d.parent().parent().append('<p class="edd-alert edd-alert-error">'+e.message+"</p>"),!1;d.parent().replaceWith('<p class="edd-alert edd-alert-success">'+e.message+"</p>"),setTimeout(function(){location.reload()},1e3)}}).fail(function(e){window.console&&window.console.log&&console.log(e)}).done(function(e){})},500)}else e("#edd-stripe-manage-cards .edd-stripe-add-new-card").slideDown(),e("#edd-stripe-add-new-cancel").show();return!1})},cancel_add_new:function(){e("#edd-stripe-add-new-cancel").click(function(d){return e("#edd-stripe-manage-cards .edd-stripe-add-new-card").slideUp(),e(this).hide(),e("#edd-stripe-add-new").show(),!1})},update:function(){e(".edd-stripe-update-card").click(function(d){return e(".card-update-form").slideUp(),e(".card-actions").show(),e(this).parent().parent().parent().find(".card-update-form").slideDown(),e(this).parent().parent().hide(),!1})},cancel_update:function(){e(".edd-stripe-cancel-update").click(function(d){return e(this).parent().parent().slideUp(),e(this).parent().parent().prev(".card-actions").show(),!1})},submit_update:function(){e(".edd-stripe-submit-update").click(function(d){var a=e(this);a.removeClass(".edd-stripe-submit-update");var t=a.width();a.find(".button-text").hide(),a.find(".edd-loading").show(),a.css("width",t),e(".edd-stripe-add-new-card .edd-alert").remove();var r=a.parent().find('input[name="card_id"]').val(),s=e("#stripe-update-card-user_id").val(),i=a.parent().parent().find(".card-update-field"),n=a.parent().find('input[name="card_update_nonce"]').val(),c={};i.each(function(d){c[e(this).data("key")]=e(this).val()});var o={edd_action:"update_stripe_card",card_id:r,user_id:s,card_data:c,nonce:n};return e.ajax({type:"POST",data:o,dataType:"json",url:edd_scripts.ajaxurl,xhrFields:{withCredentials:!0},success:function(e){if(!0!==e.success)return a.addClass(".edd-stripe-submit-update"),a.find(".button-text").show(),a.find(".edd-loading").hide(),a.parent().parent().append('<p class="edd-alert edd-alert-error">'+e.message+"</p>"),!1;a.parent().replaceWith('<p class="edd-alert edd-alert-success">'+e.message+"</p>"),setTimeout(function(){location.reload()},1e3)}}).fail(function(e){window.console&&window.console.log&&console.log(e)}).done(function(e){}),!1})},change_country:function(){e(".address_country").change(function(){var d=e(this),a={action:"edd_get_shop_states",country:d.val(),field_name:"card_state"};return e.ajax({type:"POST",data:a,url:edd_scripts.ajaxurl,xhrFields:{withCredentials:!0},success:function(a){if("nostates"==e.trim(a)){d.parent().find(".card_state").replaceWith('<input type="text" name="card_state" class="card_state card-state edd-input required" value=""/>')}else d.parent().find(".card_state").replaceWith(a)}}).fail(function(e){window.console&&window.console.log&&console.log(e)}).done(function(e){}),!1})},set_default:function(){e(".edd-stripe-default-card").click(function(d){var a=e(this).parent().parent().next(".card-update-form"),t=a.find('input[name="card_id"]').val(),r=a.find('input[name="card_update_nonce"]').val(),s=e("#stripe-update-card-user_id").val();a.html('<span class="edd-loading-ajax edd-loading"></span>'),a.show();var i={edd_action:"set_default_card",card_id:t,user_id:s,nonce:r};return e.ajax({type:"POST",data:i,dataType:"json",url:edd_scripts.ajaxurl,xhrFields:{withCredentials:!0},success:function(e){!0===e.success?a.html('<p class="edd-alert edd-alert-success">'+e.message+"</p>"):a.html('<p class="edd-alert edd-alert-error">'+e.message+"</p>"),setTimeout(function(){location.reload()},1e3)}}).fail(function(e){window.console&&window.console.log&&console.log(e)}).done(function(e){}),!1})},delete:function(){e(".edd-stripe-delete-card").click(function(d){var a=e(this).parent().parent().next(".card-update-form"),t=a.find('input[name="card_id"]').val(),r=a.find('input[name="card_update_nonce"]').val(),s=e("#stripe-update-card-user_id").val();a.html('<span class="edd-loading-ajax edd-loading"></span>'),a.show();var i={edd_action:"delete_stripe_card",card_id:t,user_id:s,nonce:r};return e.ajax({type:"POST",data:i,dataType:"json",url:edd_scripts.ajaxurl,xhrFields:{withCredentials:!0},success:function(e){!0===e.success?a.html('<p class="edd-alert edd-alert-success">'+e.message+"</p>"):a.html('<p class="edd-alert edd-alert-error">'+e.message+"</p>"),setTimeout(function(){location.reload()},1e3)}}).fail(function(e){window.console&&window.console.log&&console.log(e)}).done(function(e){}),!1})}}.init(),Stripe.setPublishableKey(edd_stripe_vars.publishable_key),e("body").on("click",'#edd-purchase-button, #edd_profile_editor_form input[type="submit"], #edd-recurring-form input[type="submit"]',function(d){if("edd_login_submit"!=e(this).attr("name")&&("stripe"==e('input[name="edd-gateway"]').val()&&e(".edd_cart_total .edd_cart_amount").data("total")>0||"stripe"==e('input[name="edd-recurring-update-gateway"]').val()))if(e(this).after('<span class="edd-loading-ajax edd-loading"></span>'),e('input[name="edd_stripe_token"]').length||"true"!=edd_stripe_vars.checkout||d.stopPropagation(),d.preventDefault(),"true"==edd_stripe_vars.checkout){if(checkout_modal_shown)return;checkout_modal_shown=!0;var a=e(".edd_cart_total .edd_cart_amount").data("total");"true"!=edd_stripe_vars.is_zero_decimal&&(a*=100,a=Math.round(a)),handler.open({name:edd_stripe_vars.store_name,amount:a,currency:edd_stripe_vars.currency,zipCode:"true"===edd_stripe_vars.zipcode,allowRememberMe:"true"===edd_stripe_vars.remember_me,alipay:"true"===edd_stripe_vars.alipay,billingAddress:"true"===edd_stripe_vars.billing_address,email:e("#edd-email").val(),closed:function(){checkout_modal_shown=!1,jQuery(".edd-loading-ajax").hide(),jQuery("#edd-purchase-button").val(edd_stripe_vars.submit_text).prop("disabled",!1)}})}else{var t;e("#edd_purchase_form #edd-purchase-button, #edd_profile_editor_form #edd_profile_editor_submit, #edd-recurring-form #edd-recurring-update-submit").attr("disabled","disabled");var r=e("input[name='edd_stripe_existing_card']:checked").val();if(void 0!==r&&"new"!==r)return edd_stripe_response_handler(!0,!1),!0;t="US"==e(".billing-country").val()?e("#card_state_us").val():"CA"==e(".billing-country").val()?e("#card_state_ca").val():e("#card_state_other").val(),t=void 0!==e("#card_state_us").val()?"US"==e(".billing-country").val()?e("#card_state_us").val():"CA"==e(".billing-country").val()?e("#card_state_ca").val():e("#card_state_other").val():e(".card_state").val();var s={};s.number=e(".card-number").val(),s.name=e(".card-name").val(),s.cvc=e(".card-cvc").val(),s.exp_month=e(".card-expiry-month").val(),s.exp_year=e(".card-expiry-year").val(),s.address_line1=e(".card-address").val(),s.address_line2=e(".card-address-2").val(),s.address_city=e(".card-city").val(),s.address_state=t,s.address_zip=e(".card-zip").val(),s.address_country=e("#billing_country").val(),edd_stripe_process_card(s,edd_stripe_response_handler)}})});var edd_global_vars,edd_scripts;if(edd_stripe_vars.publishable_key||alert(edd_stripe_vars.no_key_error),"true"==edd_stripe_vars.checkout){var checkout_modal_shown=!1,handler=StripeCheckout.configure({key:edd_stripe_vars.publishable_key,image:edd_stripe_vars.image,locale:edd_stripe_vars.locale,token:function(e){var d=jQuery("#edd_purchase_form, #edd_profile_editor_form, #edd-recurring-form");d.append("<input type='hidden' name='edd_stripe_token' value='"+e.id+"' />"),d.find("#edd-purchase-button").click()}});jQuery(window).on("popstate",function(){handler.close()})}