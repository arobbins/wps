'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.onShopifyAuth = undefined;

var _regenerator = require('babel-runtime/regenerator');

var _regenerator2 = _interopRequireDefault(_regenerator);

var _stringify = require('babel-runtime/core-js/json/stringify');

var _stringify2 = _interopRequireDefault(_stringify);

var _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

var _promise = require('babel-runtime/core-js/promise');

var _promise2 = _interopRequireDefault(_promise);

/*

Control center

*/
var onShopifyAuth = function () {
  var _ref = (0, _asyncToGenerator3.default)(_regenerator2.default.mark(function _callee($) {
    var authData, authDataResponse;
    return _regenerator2.default.wrap(function _callee$(_context) {
      while (1) {
        switch (_context.prev = _context.next) {
          case 0:
            _context.prev = 0;
            _context.next = 3;
            return isValidHMAC($);

          case 3:
            _context.next = 10;
            break;

          case 5:
            _context.prev = 5;
            _context.t0 = _context['catch'](0);


            (0, _utils.insertMessage)(_context.t0, 'error', true);
            (0, _utils.hideLoader)($('body'));

            return _context.abrupt('return');

          case 10:

            console.log('Success: validated HMAC');

            /*
             Check if hostname is valid
             */
            _context.prev = 11;
            _context.next = 14;
            return isValidHostname($);

          case 14:
            _context.next = 21;
            break;

          case 16:
            _context.prev = 16;
            _context.t1 = _context['catch'](11);


            (0, _utils.insertMessage)(_context.t1, 'error', true);
            (0, _utils.hideLoader)($('body'));

            return _context.abrupt('return');

          case 21:

            console.log('Success: validated Hostname');

            /*
             Check if Nonce is valid
             */
            _context.prev = 22;
            _context.next = 25;
            return isValidNonce($);

          case 25:
            authData = _context.sent;
            _context.next = 33;
            break;

          case 28:
            _context.prev = 28;
            _context.t2 = _context['catch'](22);


            (0, _utils.insertMessage)(_context.t2, 'error', true);
            (0, _utils.hideLoader)($('body'));

            return _context.abrupt('return');

          case 33:

            console.log('Success: validated nonce');

            /*
             Updating list of authenticated sites
             */
            _context.prev = 34;
            _context.next = 37;
            return updateAuthDataWithCode($, authData);

          case 37:
            authDataResponse = _context.sent;
            _context.next = 45;
            break;

          case 40:
            _context.prev = 40;
            _context.t3 = _context['catch'](34);


            (0, _utils.insertMessage)(_context.t3, 'error', true);
            (0, _utils.hideLoader)($('body'));

            return _context.abrupt('return');

          case 45:
            _context.prev = 45;
            _context.next = 48;
            return (0, _ws.saveAuthData)((0, _stringify2.default)(authDataResponse.updatedAuthenticatedSites));

          case 48:
            _context.next = 55;
            break;

          case 50:
            _context.prev = 50;
            _context.t4 = _context['catch'](45);


            (0, _utils.insertMessage)(_context.t4, 'error', true);
            (0, _utils.hideLoader)($('body'));
            return _context.abrupt('return');

          case 55:

            /*
             At this point we've updated the authenticated consumer with the code
            value sent from Shopify. We can now query for this value from the
            consumer side.
             */
            window.location = authDataResponse.finalRedirectURL;

            console.log('Success: updated auth data with code');

          case 57:
          case 'end':
            return _context.stop();
        }
      }
    }, _callee, this, [[0, 5], [11, 16], [22, 28], [34, 40], [45, 50]]);
  }));

  return function onShopifyAuth(_x) {
    return _ref.apply(this, arguments);
  };
}();

// console.log('Auth page');

var _find = require('ramda/src/find');

var _find2 = _interopRequireDefault(_find);

var _propEq = require('ramda/src/propEq');

var _propEq2 = _interopRequireDefault(_propEq);

var _unionWith = require('ramda/src/unionWith');

var _unionWith2 = _interopRequireDefault(_unionWith);

var _eqProps = require('ramda/src/eqProps');

var _eqProps2 = _interopRequireDefault(_eqProps);

var _utils = require('../utils/utils');

var _ws = require('../ws/ws');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/*

Checks if HMAC is valid

*/
function isValidHMAC($) {

  return new _promise2.default(function (resolve, reject) {

    var result = (0, _utils.getUrlParams)(location.search);
    var origHMAC = result.hmac;

    var dataToVerify = {
      code: result.code,
      shop: result.shop,
      state: result.state,
      timestamp: result.timestamp
    };

    var message = $.param(dataToVerify);
    var secret = 'd73e5e7fa67a54ac25a9af8ff8df3814';
    var finalDigest = crypto.createHmac('sha256', secret).update(message).digest('hex');

    if (finalDigest === origHMAC) {
      resolve("Valid HMAC");
    } else {
      reject('Error: Invalid HMAC. Please try reconnecting your WordPress site to Shopify. If you\'re still experiencing the issue send an email to <a href="mailto:hello@wpshop.io">hello@wpshop.io</a> for immediate support.');
    }
  });
};

/*

Check if hostname is valid

*/
function isValidHostname($) {

  return new _promise2.default(function (resolve, reject) {

    var result = (0, _utils.getUrlParams)(location.search);

    if (validator.isURL(result.shop)) {
      resolve("Valid hostname");
    } else {
      reject('Error: Invalid Hostname. Please try reconnecting your WordPress site to Shopify. If you\'re still experiencing the issue send an email to <a href="mailto:hello@wpshop.io">hello@wpshop.io</a> for immediate support.');
    }
  });
};

/*

Check if current nonce within the URL is valid. Checks
against the stored nonce values in the database.

*/
function isValidNonce($) {

  return new _promise2.default(function (resolve, reject) {

    var url = (0, _utils.getUrlParams)(location.search);

    if (!url.hasOwnProperty('state')) {
      reject('Error: Nonce not available. Please try reconnecting your WordPress site to Shopify. If you\'re still experiencing the issue send an email to <a href="mailto:hello@wpshop.io">hello@wpshop.io</a> for immediate support.');
    } else {

      var nonce = url.state;

      (0, _ws.getStoredAuthData)().then(function (response) {

        response = JSON.parse(response);

        var nonceMatches = (0, _find2.default)((0, _propEq2.default)('nonce', nonce))(response);

        if (nonceMatches) {
          resolve(response);
        } else {
          reject('Error: Nonce invalid or not found. Please try reconnecting your WordPress site to Shopify. If you\'re still experiencing the issue send an email to <a href="mailto:hello@wpshop.io">hello@wpshop.io</a> for immediate support.');
        }
      });
    }
  });
};

/*

Update the stored consumer entry with 'code'

*/
function updateAuthDataWithCode($, authData) {

  return new _promise2.default(function (resolve, reject) {

    var url = (0, _utils.getUrlParams)(location.search);

    if (!url.hasOwnProperty('state')) {
      reject('Error: Nonce not available. Please try reconnecting your WordPress site to Shopify. If you\'re still experiencing the issue send an email to <a href="mailto:hello@wpshop.io">hello@wpshop.io</a> for immediate support.');
    } else {

      var nonce = url.state;

      // Turn the JSON into JS object
      // var authData = JSON.parse(authData);

      console.log("authData: ", authData);

      // Finds the client which matches the nonce in the URL
      var nonceMatch = (0, _find2.default)((0, _propEq2.default)('nonce', nonce))(authData);

      console.log("nonceMatch: ", nonceMatch);

      if (nonceMatch.nonce === url.state) {
        console.log(1);
        // Verified
        nonceMatch.code = url.code;
        console.log(2);
        var newnew = nonceMatch.url + "&shop=" + encodeURIComponent(url.shop) + "&auth=true";
        console.log(3);
        // window.location.href = newnew;

        nonceMatch.code = url.code;
        console.log(4);
        var finalRedirectURL = nonceMatch.url + "&shop=" + encodeURIComponent(url.shop) + "&auth=true";
        console.log(5);
        // Conver to array so we can operate
        nonceMatch = [nonceMatch];
        console.log(6);
        // Merging updated client with everything else
        var updatedAuthenticatedSites = (0, _unionWith2.default)((0, _eqProps2.default)('domain'), nonceMatch, authData);
        console.log(7);
        // Saving client records to database
        resolve({
          finalRedirectURL: finalRedirectURL,
          updatedAuthenticatedSites: updatedAuthenticatedSites
        });
      } else {
        reject('Error: Nonce does not match. Please try reconnecting your WordPress site to Shopify. If you\'re still experiencing the issue send an email to <a href="mailto:hello@wpshop.io">hello@wpshop.io</a> for immediate support.');
      }
    }
  });
};exports.onShopifyAuth = onShopifyAuth;